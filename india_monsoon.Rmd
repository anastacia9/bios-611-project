---
title: "india_monsoon"
author: "Anastacia Wienecke"
date: "`r Sys.Date()`"
output: pdf_document
always_allow_html: true
---

Install and load packages:

```{r include=FALSE}
library(webshot)
library(terra)
library(tidyverse)
library(ggplot2)
library(mapview)
library(htmlwidgets)
library(viridis)
library(tidyr)
```

```{r}
### Read in rainfall data (annual per Indian state from 1901-2017)
rains <- read.csv("data/india_rains.csv") %>% 
         select(-Name,-Jan.Feb,-Mar.May,-June.September,-Oct.Dec)

### Compute median and variance in annual rainfall per state
meds <- rains %>%
        group_by(SUBDIVISION) %>%
        summarise_at(vars(ANNUAL), list(median=median, variance=var))
meds$stdev <- sqrt(meds$variance)
meds$stdev.norm <- meds$stdev / meds$median
meds.order <- meds$SUBDIVISION[order(meds$median, decreasing = TRUE)]
```


```{r fig.height = 10, fig.width = 10}
### Plot sampling locations on map, color by median annual rainfall
### At the top left, click the layers button below the zoom function.
### Select "Esri.WorldImagery" to see the satellite view.
latlong <- rains %>%
           select(SUBDIVISION, Latitude, Longitude) %>%
           distinct() %>%
           left_join(meds, by="SUBDIVISION")

minmed <- meds$median %>% min() %>% floor()
maxmed <- meds$median %>% max() %>% ceiling() + 300
breaks <- seq(from=minmed, to=maxmed, by=300)
ranges <- length(breaks)
colors <- rainbow(n = ranges)
india  <- mapview(latlong, xcol = "Longitude", ycol = "Latitude", crs = 4269,
                  grid = FALSE, zcol="median", col.regions = colors, at = breaks)
india
mapshot(india, file = "figures/india.png")
saveWidget(india@map, file="figures/india.html")
```


You could turn this into a boxplot too?
``` {r fig.height = 10, fig.width = 10, echo=FALSE}
### Assign colors to dataframe
entrys <- latlong$SUBDIVISION %>% length()
shades <- rep('', entrys)
for (i in 1:entrys){
  distances <- latlong$median[i]-breaks > 0
  shades[i] <- colors[distances %>% which() %>% max()]}
latlong$colorful <- shades


### Basic barplots of annual rainfall for 1901, 1925, 1950, 1975, 2000, and 2017
years <- c(1901,1925,1950,1975,2000,2017)
rains.per25years <- rains %>%
                    filter(YEAR %in% years) %>%
                    merge(latlong[c('SUBDIVISION', 'colorful')], 
                          by=c("SUBDIVISION"))
meds.factor <- factor(rains.per25years$SUBDIVISION, levels=meds.order)
rains.per25years <- rains.per25years[order(meds.factor),]
rains.per25years$SUBDIVISION <- factor(rains.per25years$SUBDIVISION,
                                       levels = meds.order)

bars <- ggplot(data=rains.per25years, aes(x=SUBDIVISION, y=ANNUAL,
                                          fill=colorful)) +
               geom_bar(stat="identity", show.legend = FALSE) +
               scale_x_discrete(guide = guide_axis(angle = 90)) +
               facet_grid(YEAR ~ ., scales = "free_y") +
               coord_cartesian(ylim = c(0, 4500)) +
               labs(x = "State",
                    y = "Median Rainfall",
                title = "Barplot of annual rainfall for years 1901, 1925, 1950,
                1975, 2000, and 2017")
bars
ggsave("figures/quarter_century_rainfall.png", bars)
```

``` {r echo=FALSE}
### Median monthly rainfall for each state
rains.col <- merge(rains, latlong[c('SUBDIVISION', 'colorful')],
                   by=c("SUBDIVISION"))
indexs <- c(1,2,3,4,5,8,9,11)
graphs <- list()
count  <- 1
for(i in indexs){
rains.info <- rains.col %>%
              filter(colorful %in% colors[i]) %>%
              pivot_longer(
                cols = JAN:DEC,
                names_to = "month",
                values_to = "rainfall") %>%
              group_by(month,SUBDIVISION) %>%
              summarise_at(vars(rainfall), 
                           list(median=median,
                                Q1=~quantile(., probs = 0.25),
                                Q3=~quantile(., probs = 0.75)))
rains.info$month <- factor(rains.info$month, levels = c("JAN", "FEB", "MAR",
                                                        "APR", "MAY", "JUN",
                                                        "JUL", "AUG", "SEP",
                                                        "OCT", "NOV", "DEC"))

graphs[[count]] <- ggplot(rains.info, aes(month, median, color=SUBDIVISION,
                                          group=SUBDIVISION)) +
                          geom_point() +
                          geom_line() +
                          #geom_errorbar(aes(ymin = Q1, ymax = Q3)) +
                          labs(x = "month",
                               y = "median rainfall between 1901 and 2017")
ggsave(paste('figures/median_monthly_rainfall_lineplot',as.character(count),'.png',
             sep=''), graphs[[count]] )
count <- count + 1 
}
graphs
```

``` {r}
### Comparison of median annual rainfall and the standard deviation in annual rainfall
# Non-normalized
nnorms <- ggplot(data=meds, aes(x=median, y=stdev)) +
                 geom_line() +
                 geom_point() +
                 labs(x = "Median Annual Rainfall",
                      y = "Standard Deviation in Annual Rainfall",
                  title = "Line plot of median annual rainfall vs. the standard deviation in annual rainfall")
ggsave("figures/lineplot_median_stdev_rainfall.png", nnorms)
nnorms

# Normalized
norms <- ggplot(data=meds, aes(x=median, y=stdev.norm)) +
                geom_line() +
                geom_point() +
                labs(x = "Median Annual Rainfall",
                     y = "Scaled Standard Deviation in Annual Rainfall",
                 title = "Line plot of median annual rainfall vs. the scaled standard deviation in annual rainfall\n(standard deviation divided by median)")
ggsave("figures/lineplot_median_norm_stdev_rainfall.png", norms)
norms
```

Ideas:
- yearly average rainfall
- annual rainfall boxplot per subdivision over time
- with the crops data, try a PCA with crop production of each state in a single year; how much does this change yearly within a 10-year period (or between another set of years). Will need to normalize by total crop production by that state; which states form clusters? is this related to rainfall?


``` {r}
### Read in crops data (annual per Indian state from 1901-2017)
crops <- read.csv("data/india_crops.csv")

### Standardize state labels between crops data and rains data
crops.state <- unique(crops$State_Name) # these state names are most accurate according to "knowindia.india.gov.in"
rains.state <- unique(rains$SUBDIVISION)

crops <- crops %>%
         mutate(State_Name = replace(State_Name,
                                     State_Name=="Assam"|State_Name=='Meghalaya',
                                     "Assam and Meghalaya")) %>%
         mutate(State_Name = replace(State_Name,
                                     State_Name=="Chandigarh"|State_Name=='Haryana',
                                     "Chandigarh and Haryana")) %>%  
         mutate(State_Name = replace(State_Name,
                                     State_Name=="Goa"|State_Name=='Maharashtra',
                                     "Goa and Maharashtra")) %>%
         mutate(State_Name = replace(State_Name,
                                     State_Name=="Manipur"|State_Name=='Mizoram'|
                                     State_Name=='Nagaland'|State_Name=='Tripura',
                                     "Nagaland, Manipur, Mizoram, Tripura")) %>% 
         mutate(State_Name = replace(State_Name,
                                     State_Name=="Sikkim"|State_Name=='West Bengal',
                                     "Sikkim and West Bengal")) %>%
         mutate(State_Name = replace(State_Name,
                                     State_Name=="Jammu and Kashmir ",
                                     "Jammu and Kashmir")) %>%  
         mutate(State_Name = replace(State_Name,
                                     State_Name=="Telangana ",
                                     "Telangana")) %>%  
         filter(!State_Name %in% c('Dadra and Nagar Haveli','Puducherry')) %>%
         select(State_Name, Crop_Year, Crop, Area, Production)

rains <- rains %>%
         mutate(SUBDIVISION = replace(SUBDIVISION,
                                      SUBDIVISION=="Andaman & Nicobar Islands",
                                     "Andaman and Nicobar Islands")) %>%
         mutate(SUBDIVISION = replace(SUBDIVISION,
                                      SUBDIVISION=="Coastal Andhra Pradesh"|
                                      SUBDIVISION=="Rayalseema",
                                     "Andhra Pradesh")) %>%
         mutate(SUBDIVISION = replace(SUBDIVISION,
                                      SUBDIVISION=="Assam & Meghalaya",
                                      "Assam and Meghalaya")) %>%
         mutate(SUBDIVISION = replace(SUBDIVISION,
                                      SUBDIVISION=="Haryana Delhi & Chandigarh",
                                      "Chandigarh and Haryana")) %>%  
         mutate(SUBDIVISION = replace(SUBDIVISION,
                                      SUBDIVISION=="Konkan & Goa"|
                                      SUBDIVISION=="Madhya Maharashtra"|
                                      SUBDIVISION=="Vidarbha"|
                                      SUBDIVISION=="Matathwada",
                                      "Goa and Maharashtra")) %>%  
         mutate(SUBDIVISION = replace(SUBDIVISION,
                                      SUBDIVISION=="Gujarat Region"|
                                      SUBDIVISION=="Saurashtra & Kutch",
                                      "Gujarat")) %>%
         mutate(SUBDIVISION = replace(SUBDIVISION,
                                      SUBDIVISION=="Jammu & Kashmir",
                                      "Jammu and Kashmir")) %>%
         mutate(SUBDIVISION = replace(SUBDIVISION,
                                      SUBDIVISION=="Coastal Karnataka"|
                                      SUBDIVISION=="North Interior Karnataka"|
                                      SUBDIVISION=="South Interior Karnataka",
                                      "Karnataka")) %>% 
         mutate(SUBDIVISION = replace(SUBDIVISION,
                                      SUBDIVISION=="West Madhya Pradesh"|
                                      SUBDIVISION=="East Madhya Pradesh",
                                      "Madhya Pradesh")) %>% 
         mutate(SUBDIVISION = replace(SUBDIVISION,
                                      SUBDIVISION=="Naga Mani Mizo Tripura",
                                      "Nagaland, Manipur, Mizoram, Tripura")) %>%
         mutate(SUBDIVISION = replace(SUBDIVISION,
                                      SUBDIVISION=="Orissa",
                                      "Odisha")) %>%
         mutate(SUBDIVISION = replace(SUBDIVISION,
                                      SUBDIVISION=="West Rajasthan"|
                                      SUBDIVISION=="East Rajasthan",
                                      "Rajasthan")) %>% 
         mutate(SUBDIVISION = replace(SUBDIVISION,
                                      SUBDIVISION=="Sub Himalayan West Bengal & Sikkim"|
                                      SUBDIVISION=="Gangetic West Bengal",
                                      "Sikkim and West Bengal")) %>% 
         mutate(SUBDIVISION = replace(SUBDIVISION,
                                      SUBDIVISION=="Sub Himalayan West Bengal & Sikkim"|
                                      SUBDIVISION=="Gangetic West Bengal",
                                      "Sikkim and West Bengal")) %>% 
         mutate(SUBDIVISION = replace(SUBDIVISION,
                                      SUBDIVISION=="East Uttar Pradesh"|
                                      SUBDIVISION=="West Uttar Pradesh",
                                      "Uttar Pradesh")) %>% 
         filter(!SUBDIVISION %in% c('Lakshadweep'))
```

``` {r}
### Which crops appear most frequently in this dataset?
crop.counts <- rev(stack(table(crops$Crop)))
crop.counts <- crop.counts[order(crop.counts$values, decreasing=T),]
head(crop.counts)

### Get total crop area and production for each state per year
crops.tot.area <- crops %>% group_by(State_Name, Crop_Year, Crop) %>% summarise(Area = sum(Area))
crops.tot.prod <- crops %>% group_by(State_Name, Crop_Year, Crop) %>% summarise(Production = sum(Production))
crops.tot.area.wide <- crops.tot.area %>% 
                       pivot_wider(names_from = Crop, values_from = Area) %>%
                       replace(is.na(.), 0)
crops.tot.prod.wide <- crops.tot.prod %>% 
                       pivot_wider(names_from = Crop, values_from = Production) %>%
                       replace(is.na(.), 0)

### Combine crops that appear less than 500 times as "other"
other <- crop.counts$ind[crop.counts$values<500]
crops.tot.area.wide$other <- rowSums(crops.tot.area.wide[,other])
crops.tot.prod.wide$other <- rowSums(crops.tot.prod.wide[,other])
crops.tot.area.wide <- crops.tot.area.wide %>% select(-one_of(other))
crops.tot.prod.wide <- crops.tot.prod.wide %>% select(-one_of(other))



    
  df %>% group_by(x) %>% summarise(y = sum(y))
  
         group_by(State_Name, Crop_Year, Crop) %>%
         summarise(n = dplyr::n(), .groups = "drop") %>%
         filter(n > 1L) %>%

  a<-crops %>% pivot_wider(names_from = Crop, values_from = Area)

crops <- crops %>% mutate(Crop = replace(Crop,Crop %in% other,"other"))
a <- crops %>% pivot_wider(names_from = Crop, values_from = Area)



%>% filter(Crop %in% other)

tail(crop.counts)
hist(log(crop.counts$values), breaks=100)

```


